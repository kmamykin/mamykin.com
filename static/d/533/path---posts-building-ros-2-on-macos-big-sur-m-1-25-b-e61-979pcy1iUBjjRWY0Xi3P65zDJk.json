{"data":{"site":{"siteMetadata":{"siteUrl":"http://mamykin.com","disqusShortname":"mamykin-com"}},"post":{"frontmatter":{"permalink":"/posts/building-ros2-on-macos-big-sur-m1/","title":"How to build and install ROS2 on macOS Big Sur M1","author":"Kliment Mamykin","date":"2021-06-02","image":"","tags":["macOS","ROS2","robotics","Apple Silicon","M1"]},"content":{"type":"Markdown","markdown":"\nThis is a detailed list of instructions with workarounds to build a ROS2 distribution (galactic in this case) on the latest Apple's macOS (Big Sur with Apple Silicon M1 processor). Not every tool has been tested on Big Sur+M1 and some tools have been disabled in the build as temp workarounds.\n\nFor the current status of the known issues the progress is tracked [HERE](https://github.com/ros2/ros2/issues/1148).\n\nIn general this article follows the build instructions of [galactic ROS2 release](https://docs.ros.org/en/galactic/Installation/macOS-Development-Setup.html). The process is modified to add Python virtual environment, direnv, and various workarounds to fix the current issues. No System Integrity Protection (SIP) disabling is required, and the only global footprint on the machine is the packages installed through Homebrew.\n\n## Directory layout\n\n```\n<root>                              - the root directory for this experiment\n  ├── .envrc                        - direnv file to setup env vars, source various files etc\n  ├── .venv/                        - local Python virtual environment\n  ├── ros2_galactic/                - ROS2 workspace, most of the commands will be run here\n  │   ├── {src|build|install|log}   - various directories \n  │\n  ├── Pillow/                       - not ROS related packages, to build or experiment out of ROS workspace\n  └── numpy/                        - another out of ROS workspace repo\n```\n\n## Homebrew\n\nHomebrew is installed into a different location `/opt/homebrew` on Apple Silicon Mac. But in order to be compatible with Intel based machines, it's best to use `$(brew --prefix)` expansion to get the location of Homebrew installed packages.\n\n## direnv\n\n`direnv` is a tool to manage separate shell environments per project. `cd` into a directory executes `.envrc` file and captures all exported environment variables. `cd` out of the directory and the shell environment is reverted. This is perfect to automatically source Python virtual env or ROS setup scripts.\n\n`brew install direnv` and follow the instructions to update your shell dot files (.bashrc or .zshrc).\n\n## Python virtual environment\n\nInside the <root> directory:\n\n```\n# python3 --version\nPython 3.9.5\n# python3 -m venv .venv\n# echo \"source .venv/bin/activate \\nunset PS1\" >> .envrc\ndirenv: error .../.envrc is blocked. Run `direnv allow` to approve its content\n# direnv allow\n# which python\n<root>/.venv/bin/python\n# which pip\n<root>/.venv/bin/pip\n# pip install --upgrade pip && pip list\n...\nPackage    Version\n---------- -------\npip        21.1.2\nsetuptools 56.0.0\n```\n\nWe are now in a prestene Python virtual environment.\n\n## Install prerequisites\n\nFollow \"Install prerequisites\" from https://docs.ros.org/en/galactic/Installation/macOS-Development-Setup.html\n\nExcept `export OPENSSL_ROOT_DIR=$(brew --prefix openssl)` could go to the `.envrc` file.\nAdd `export Qt5_DIR=$(brew --prefix qt@5)/lib/cmake` to `.envrc` as well.\n\nThere is no need to set `export CMAKE_PREFIX_PATH` at this time because later on we will pass it as an explicit parameter to `colcon`.\n\nInstall Python packages:\n\n```\npip install -U \\\n argcomplete catkin_pkg colcon-common-extensions coverage \\\n cryptography empy flake8 flake8-blind-except flake8-builtins \\\n flake8-class-newline flake8-comprehensions flake8-deprecated \\\n flake8-docstrings flake8-import-order flake8-quotes ifcfg \\\n importlib-metadata lark-parser lxml mock mypy netifaces \\\n nose pep8 pydocstyle pydot pygraphviz pyparsing \\\n pytest-mock rosdep setuptools vcstool psutil rosdistro\n```\n\nNote, `matplotlib` is missing from this list, requires a few extra steps.\n\nI also installed [rosinstall-generator](http://wiki.ros.org/rosinstall_generator) (but this is optional).\n\n```\npip install rosinstall-generator\n```\n\n#### Build numpy and Pillow from source\n\nhttps://stackoverflow.com/questions/66204654/unable-to-install-matplotlib-with-python3-on-m1-mac-using-pip3\n\nNote that the location of numpy and Pillow directories must be outside of the `ros2_galactic` directory. \n\n```\ncd <root>\npip install Cython\ngit clone https://github.com/numpy/numpy.git\ncd numpy\npip install . --no-binary :all: --no-use-pep517\ncd ..\ngit clone https://github.com/python-pillow/Pillow.git\ncd Pillow\npip install . --no-binary :all: --no-use-pep517\n```\n\nand finally install matplotlib\n\n```\n# pip install matplotlib\n...there will be some errors here but matplotlib installs successfully...\n# pip list | grep matplotlib\nmatplotlib                 3.4.2\n```\n\n## SIP\n\nNo need to disable System Integrity Protection (SIP)\n\n## Get the ROS 2 code\n\nNo change from https://docs.ros.org/en/galactic/Installation/macOS-Development-Setup.html#get-the-ros-2-code\n\n## Build the ROS 2 code\n\nThis is where the fun starts. I started with the following colcon build command:\n\n```\ncolcon build \\\n  --symlink-install \\\n  --merge-install \\\n  --event-handlers console_cohesion+ console_package_list+ \\\n  --packages-skip-by-dep python_qt_binding \\\n  --cmake-args \\\n    --no-warn-unused-cli \\\n    -DBUILD_TESTING=OFF \\\n    -DINSTALL_EXAMPLES=ON \\\n    -DCMAKE_OSX_SYSROOT=/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk \\\n    -DCMAKE_OSX_ARCHITECTURES=\"arm64\" \\\n    -DCMAKE_PREFIX_PATH=$(brew --prefix):$(brew --prefix qt@5)\n```\n\nLet's take it apart. The build is done with [colcon](https://colcon.readthedocs.io/en/released/index.html) tool, which reads `package.xml`\nfrom each repository installed in `src`, builds a DAG of dependencies, and then executes package builds in the correct topological order. \n`--symlink-install` created symlins inside the install directory. `--merge-install` creates a flatter install directory that results in shorter PATHs when sourcing install/setup.sh later on. `--event-handlers console_cohesion+ console_package_list+` gives a slightly better console logging. \n\nAll `--cmake-args` are necessary to properly build the distro on Big Sur + M1. \n\n### Patches\n\nOn the failure to build `osrf_testing_tools_cpp`\n\n```\nIn file included from .../ros2_galactic/src/osrf/osrf_testing_tools_cpp/osrf_testing_tools_cpp/src/memory_tools/stack_trace.cpp:17:\nIn file included from .../ros2_galactic/src/osrf/osrf_testing_tools_cpp/osrf_testing_tools_cpp/src/memory_tools/./stack_trace_impl.hpp:31:\n.../ros2_galactic/src/osrf/osrf_testing_tools_cpp/osrf_testing_tools_cpp/src/memory_tools/./vendor/bombela/backward-cpp/backward.hpp:3931:60: error: member reference type 'struct __darwin_mcontext64 *' is a pointer; did you mean to use '->'?\n    error_addr = reinterpret_cast<void *>(uctx->uc_mcontext.pc);\n                                          ~~~~~~~~~~~~~~~~~^\n                                                           ->\n```\n\npatch `src/osrf/osrf_testing_tools_cpp/osrf_testing_tools_cpp/src/memory_tools/vendor/bombela/backward-cpp/backward.hpp`\n\n```\n--- a/src/memory_tools/vendor/bombela/backward-cpp/backward.hpp\n+++ b/src/memory_tools/vendor/bombela/backward-cpp/backward.hpp\n@@ -3927,8 +3927,10 @@ public:\n     error_addr = reinterpret_cast<void *>(uctx->uc_mcontext.gregs[REG_EIP]);\n #elif defined(__arm__)\n     error_addr = reinterpret_cast<void *>(uctx->uc_mcontext.arm_pc);\n-#elif defined(__aarch64__)\n+#elif defined(__aarch64__) && !defined(__APPLE__)\n     error_addr = reinterpret_cast<void *>(uctx->uc_mcontext.pc);\n+#elif defined(__APPLE__) && defined(__aarch64__)\n+    error_addr = reinterpret_cast<void *>(uctx->uc_mcontext->__ss.__pc);\n #elif defined(__mips__)\n     error_addr = reinterpret_cast<void *>(reinterpret_cast<struct sigcontext*>(&uctx->uc_mcontext)->sc_pc);\n #elif defined(__ppc__) || defined(__powerpc) || defined(__powerpc__) ||        \\\n```\n\nOn the failure to build `rviz_ogre_vendor`\n\n```\nUndefined symbols for architecture x86_64:\n  \"_FT_Done_FreeType\", referenced from:\n      Ogre::Font::loadResource(Ogre::Resource*) in OgreFont.cpp.o\n  \"_FT_Init_FreeType\", referenced from:\n      Ogre::Font::loadResource(Ogre::Resource*) in OgreFont.cpp.o\n  \"_FT_Load_Char\", referenced from:\n      Ogre::Font::loadResource(Ogre::Resource*) in OgreFont.cpp.o\n  \"_FT_New_Memory_Face\", referenced from:\n      Ogre::Font::loadResource(Ogre::Resource*) in OgreFont.cpp.o\n  \"_FT_Set_Char_Size\", referenced from:\n      Ogre::Font::loadResource(Ogre::Resource*) in OgreFont.cpp.o\nld: symbol(s) not found for architecture x86_64\nclang: error: linker command failed with exit code 1 (use -v to see invocation)\nmake[5]: *** [lib/macosx/libOgreOverlay.1.12.1.dylib] Error 1\nmake[4]: *** [Components/Overlay/CMakeFiles/OgreOverlay.dir/all] Error 2\nmake[4]: *** Waiting for unfinished jobs....\nmake[3]: *** [all] Error 2\nmake[2]: *** [ogre-v1.12.1-prefix/src/ogre-v1.12.1-stamp/ogre-v1.12.1-build] Error 2\nmake[1]: *** [CMakeFiles/ogre-v1.12.1.dir/all] Error 2\nmake: *** [all] Error 2\n```\n\npatch `src/ros2/rviz/rviz_ogre_vendor/CMakeLists.txt`\n\n```\ndiff --git a/CMakeLists.txt b/CMakeLists.txt\nindex faac7e1b..c36877c3 100644\n--- a/CMakeLists.txt\n+++ b/CMakeLists.txt\n@@ -120,7 +120,7 @@ macro(build_ogre)\n     set(OGRE_CXX_FLAGS \"${OGRE_CXX_FLAGS} /w /EHsc\")\n   elseif(APPLE)\n     set(OGRE_CXX_FLAGS \"${OGRE_CXX_FLAGS} -std=c++14 -stdlib=libc++ -w\")\n-    list(APPEND extra_cmake_args \"-DCMAKE_OSX_ARCHITECTURES='x86_64'\")\n+    list(APPEND extra_cmake_args \"-DCMAKE_OSX_ARCHITECTURES='arm64'\")\n   else()  # Linux\n     set(OGRE_C_FLAGS \"${OGRE_C_FLAGS} -w\")\n     # include Clang -Wno-everything to disable warnings in that build. GCC doesn't mind it\n```\n\nOn another failure to build `rviz_ogre_vendor`\n\n```\nIn file included from /Users/kmamykin/Projects/ros2-build-on-macOS/ros2_galactic/build/rviz_ogre_vendor/ogre-v1.12.1-prefix/src/ogre-v1.12.1/OgreMain/src/OgreOptimisedUtilSSE.cpp:36:\nIn file included from /Users/kmamykin/Projects/ros2-build-on-macOS/ros2_galactic/build/rviz_ogre_vendor/ogre-v1.12.1-prefix/src/ogre-v1.12.1/OgreMain/src/OgreSIMDHelper.h:69:\nIn file included from /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/clang/12.0.5/include/xmmintrin.h:13:\n/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/clang/12.0.5/include/mmintrin.h:33:5: error: use of undeclared identifier '__builtin_ia32_emms'; did you mean '__builtin_isless'?\n    __builtin_ia32_emms();\n    ^\n/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX11.3.sdk/usr/include/c++/v1/math.h:649:12: note: '__builtin_isless' declared here\n    return isless(__lcpp_x, __lcpp_y);\n           ^\n/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX11.3.sdk/usr/include/math.h:545:22: note: expanded from macro 'isless'\n#define isless(x, y) __builtin_isless((x),(y))\n                     ^\n```\n\nupdate `build/rviz_ogre_vendor/ogre-v1.12.1-prefix/src/ogre-v1.12.1/OgreMain/include/OgrePlatformInformation.h` (which is downloaded during the build, so you need to try building rviz_ogre_vendor at least once).\n\n```\n--- build/rviz_ogre_vendor/ogre-v1.12.1-prefix/src/ogre-v1.12.1/OgreMain/include/OgrePlatformInformation.h.orig\t2021-06-02 16:28:58.000000000 -0400\n+++ build/rviz_ogre_vendor/ogre-v1.12.1-prefix/src/ogre-v1.12.1/OgreMain/include/OgrePlatformInformation.h\t2021-06-02 16:30:50.000000000 -0400\n@@ -50,11 +50,11 @@\n #   define OGRE_CPU OGRE_CPU_X86\n\n #elif OGRE_PLATFORM == OGRE_PLATFORM_APPLE && defined(__BIG_ENDIAN__)\n #   define OGRE_CPU OGRE_CPU_PPC\n #elif OGRE_PLATFORM == OGRE_PLATFORM_APPLE\n-#   define OGRE_CPU OGRE_CPU_X86\n+#   define OGRE_CPU OGRE_CPU_ARM\n #elif OGRE_PLATFORM == OGRE_PLATFORM_APPLE_IOS && (defined(__i386__) || defined(__x86_64__))\n #   define OGRE_CPU OGRE_CPU_X86\n #elif defined(__arm__) || defined(_M_ARM) || defined(__arm64__) || defined(__aarch64__)\n #   define OGRE_CPU OGRE_CPU_ARM\n #elif defined(__mips64) || defined(__mips64_)\n```\n\n## Testing the install\n\nOnce you have a successful build, you can test it, for example by running `rviz2`:\n\n```\nsource ./install/setup.sh\n./install/bin/rviz2\n```\n\nEnjoy!\n","notebook":null}}},"pageContext":{"permalink":"/posts/building-ros2-on-macos-big-sur-m1/"}}